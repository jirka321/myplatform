<!doctype html>
<html lang="cs">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Mapa priorit</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@500;700&family=Work+Sans:wght@400;500;600&display=swap" rel="stylesheet">
  <style>
    :root{
      --text:#0f1a24;
      --muted:#4b6b88;
      --border:rgba(0,0,0,.08);
      --accent-a:#0090ff;
      --accent-b:#26b0ff;
    }

    html,body{height:100%}
    body{ margin:0; background:#ffffff; color:var(--text); font-family:"Work Sans", system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Arial; overflow-x:hidden; }

    .bg{ position:fixed; inset:-20vh -20vw -20vh -20vw; pointer-events:none; z-index:0; overflow:hidden; }
    .bg::before{ content:""; position:absolute; width:82vmin; height:82vmin; left:50%; top:46%; transform:translate(-50%,-50%); background:radial-gradient(circle at 50% 50%, rgba(0,185,255,.44) 0%, rgba(92,122,255,.40) 33%, rgba(255,120,200,.30) 58%, rgba(0,0,0,0) 72%); filter: blur(120px); opacity:.92; animation:none; }
    .bg::after{ content:""; position:absolute; width:48vmin; height:48vmin; left:50%; top:46%; transform:translate(-50%,-50%); background:radial-gradient(circle at 50% 50%, rgba(255,255,255,.80) 0%, rgba(255,255,255,.0) 60%); filter: blur(30px); opacity:.9; animation:none; }
    @keyframes pulse { 0%{transform:scale(1);opacity:.95;filter:blur(90px)} 50%{transform:scale(1.15);opacity:.85;filter:blur(120px)} 100%{transform:scale(1);opacity:.95;filter:blur(90px)} }
    @keyframes drift { 0%{transform:translate3d(-2vw,-2vh,0) scale(1)} 50%{transform:translate3d(2vw,1vh,0) scale(1.08)} 100%{transform:translate3d(-2vw,-2vh,0) scale(1)} }

    .blob{ position:absolute; border-radius:50%; filter: blur(110px); transform: translateZ(0); opacity:.18; }
    .blob.r1{ width:64vmin; height:64vmin; left:calc(50% - 44vmin); top:calc(50% - 18vmin); background:radial-gradient(circle at 50% 50%, rgba(255,80,80,0.55) 0%, rgba(255,80,80,0.22) 45%, rgba(255,80,80,0) 72%); animation: drift 14s ease-in-out infinite; }
    .blob.r2{ width:50vmin; height:50vmin; left:calc(50% + 24vmin); top:calc(50% - 26vmin); background:radial-gradient(circle at 50% 50%, rgba(255,120,120,0.50) 0%, rgba(255,120,120,0.20) 45%, rgba(255,120,120,0) 72%); animation: pulse 10s ease-in-out infinite; }
    .blob.y1{ width:70vmin; height:70vmin; left:calc(50% - 28vmin); top:calc(50% + 24vmin); background:radial-gradient(circle at 50% 50%, rgba(255,210,0,0.54) 0%, rgba(255,210,0,0.20) 45%, rgba(255,210,0,0) 72%); animation: drift 16s ease-in-out infinite; }
    .blob.y2{ width:48vmin; height:48vmin; left:calc(50% + 22vmin); top:calc(50% + 10vmin); background:radial-gradient(circle at 50% 50%, rgba(255,180,0,0.52) 0%, rgba(255,180,0,0.20) 45%, rgba(255,180,0,0) 72%); animation: pulse 12s ease-in-out infinite; }
    .blob.y3{ width:40vmin; height:40vmin; left:50%; top:50%; transform:translate(-50%,-50%); background:radial-gradient(circle at 50% 50%, rgba(255,230,90,0.50) 0%, rgba(255,230,90,0.18) 45%, rgba(255,230,90,0) 72%); animation: drift 11s ease-in-out infinite; }

    .wrap{ position:relative; z-index:1; min-height:100%; display:flex; align-items:center; justify-content:center; padding:6vh 4vw; }
    .glass{ width:min(1180px, 100%); border-radius:20px; background: transparent; border: none; box-shadow: none; backdrop-filter: none; -webkit-backdrop-filter: none; }
    .card{ padding:18px 20px; border:1px solid rgba(255,255,255,.35); border-radius:18px; background:rgba(255,255,255,.55); box-shadow:0 8px 22px rgba(15,27,36,.07); backdrop-filter: blur(16px) saturate(140%); -webkit-backdrop-filter: blur(16px) saturate(140%); }

    header{ display:flex; align-items:center; justify-content:space-between; gap:16px; padding:18px 22px; border-bottom:1px solid var(--border) }
    .brand{ display:flex; align-items:center; gap:10px; font-family:'Quicksand', sans-serif; font-weight:800; letter-spacing:.4px; }
    .pill{ border:1px solid rgba(0,120,255,.18); background:rgba(0,120,255,.08); border-radius:999px; padding:6px 12px; font-size:12px; color:#0f3555; }

    .progressRow{ display:flex; align-items:center; gap:14px; }
    .circleWrap{ position:relative; width:56px; height:56px; }
    .circleWrap svg{ transform:rotate(-90deg) }
    .circle-track{ stroke: rgba(15,27,36,.12); }
    .circle-bar{ stroke: url(#grad); filter: drop-shadow(0 0 6px rgba(0,140,255,.4)); transition: stroke-dashoffset .3s ease; }
    .circleWrap .pct{ position:absolute; inset:0; display:grid; place-items:center; font-family:'Quicksand', sans-serif; font-weight:800; font-size:12px; color:#274156; transform:translateZ(0); }

    .progress{ flex:1; height:8px; background:rgba(15,27,36,.06); border:1px solid rgba(15,27,36,.08); border-radius:999px; overflow:hidden; }
    .bar{ height:100%; width:0%; background:linear-gradient(90deg, var(--accent-a), var(--accent-b)); box-shadow: 0 4px 18px rgba(0,140,255,.35); transition:width .3s ease; }

    main{ padding:20px 26px 28px }
    h1{ font-family:'Quicksand', sans-serif; margin:0 0 6px; font-size:28px }
    .kicker{ color:var(--muted); font-size:14px; margin-bottom:12px }
    .statementBox{ font-size:20px; font-weight:700; line-height:1.35; padding:18px; border:1px solid rgba(15,27,36,.10); border-radius:14px; background:linear-gradient(180deg, rgba(255,255,255,.9), rgba(255,255,255,.75)); color:#0f1a24; }

    .scale{ display:grid; grid-template-columns:repeat(4,1fr); gap:12px; margin-top:14px }
    .choice{ border:1px solid rgba(15,27,36,.10); border-radius:12px; padding:14px 12px; text-align:center; font-weight:700; cursor:pointer; user-select:none; background:#ffffff; color:#0f1a24; transition:transform .08s ease, box-shadow .12s ease, border-color .12s ease; box-shadow:0 1px 0 rgba(15,27,36,.04); }
    .choice:hover{ border-color:rgba(0,140,255,.35); box-shadow:0 4px 14px rgba(0,140,255,.08); transform:translateY(-1px); }
    .choice input{ display:none }
    .choice.selected{ border-color:rgba(0,140,255,.55); background:linear-gradient(180deg, rgba(0,140,255,.10), rgba(0,140,255,.06)); color:#0f3555 }

    .controls{ display:flex; align-items:center; justify-content:space-between; gap:12px; margin-top:16px }
    .hint{ color:var(--muted); font-size:13px }
    .btn{ border:none; padding:12px 18px; border-radius:999px; font-family:'Quicksand', sans-serif; font-weight:800; cursor:pointer; }
    .btn.primary{ color:#00150b; background:linear-gradient(90deg, var(--accent-a), var(--accent-b)); }
    .btn.secondary{ background:#fff; border:1px solid rgba(15,27,36,.12); color:#0f1a24 }

    .pair{ display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-top:14px }
    .optionCard{ border:1px solid rgba(15,27,36,.10); border-radius:14px; padding:16px; cursor:pointer; background:#fff; transition:box-shadow .12s ease, border-color .12s ease, transform .08s ease; }
    .optionCard:hover{ border-color:rgba(0,140,255,.35); box-shadow:0 6px 20px rgba(0,140,255,.08); transform:translateY(-1px); }
    .optionCard .name{ font-weight:800; color:#0f1a24 }

    .summary{ display:grid; gap:18px; grid-template-columns: 2fr 1.1fr; align-items:start }
    .summary > div:nth-child(2){ position:sticky; top:24px }
    @media (max-width: 1100px){
      .summary{ grid-template-columns: 1fr; }
      .summary > div:nth-child(2){ position:static; }
    }
    .board{ display:grid; grid-template-columns: 2fr 1.1fr; gap:18px; align-items:start; grid-template-areas:
      "stat stat"
      "pod  graph"
      "top5 graph"; }
    .box-stat{ grid-area: stat; }
    .box-podium{ grid-area: pod; }
    .box-top5{ grid-area: top5; }
    .box-graph{ grid-area: graph; position:sticky; top:24px }
    @media (max-width:1100px){
      .board{ grid-template-columns:1fr; grid-template-areas:
        "stat"
        "graph"
        "pod"
        "top5"; }
      .box-graph{ position:static }
    }
    .podium{ display:grid; grid-template-columns: 1fr 1fr 1fr; gap:12px; align-items:end; }
    /* --- TOP3 cards (1→3) --- */
    .top3{ display:grid; grid-template-columns: repeat(3, 1fr); gap:12px; }
    .top3 .item{ position:relative; border:1px solid rgba(15,27,36,.10); border-radius:18px; padding:16px; background:#ffffff; box-shadow:none; }
    .top3 .item .head{ display:flex; align-items:center; gap:10px; margin-bottom:6px }
    .top3 .item .badge{ display:inline-grid; place-items:center; width:34px; height:34px; border-radius:50%; font-family:'Quicksand',sans-serif; font-weight:800; font-size:13px; color:#00150b; background:linear-gradient(90deg, var(--accent-a), var(--accent-b)); box-shadow:0 6px 16px rgba(0,140,255,.25) }
    .top3 .item .title{ font-family:'Quicksand',sans-serif; font-weight:800; font-size:16px }
    .top3 .item .meta{ color:#4b6b88; font-size:12px; margin:6px 0 8px }
    .top3 .item .desc{ font-size:13px; line-height:1.35; color:#0f1a24 }
    /* pastel tints like schedule cards */
    .top3 .item.c1{ background:#eaf5ff; border-color: rgba(0,144,255,.20) }
    .top3 .item.c2{ background:#e9fbf6; border-color: rgba(0,200,170,.20) }
    .top3 .item.c3{ background:#fff6e0; border-color: rgba(255,180,0,.22) }
    @media (max-width:900px){ .top3{ grid-template-columns: 1fr } }
    .col{ position:relative; background:#fff; border:1px solid rgba(15,27,36,.10); border-radius:12px; height:var(--h,120px); display:grid; place-items:center; box-shadow:0 3px 10px rgba(15,27,36,.05) }
    .rank{ position:absolute; top:6px; left:8px; font-weight:800; font-family:'Quicksand', sans-serif; font-size:12px; color:#0b61d6 }
    .name{ font-weight:800; font-family:'Quicksand', sans-serif; text-align:center; color:#0f1a24 }
    table{ width:100%; border-collapse:collapse; margin-top:10px; font-size:14px; color:#0f1a24 }
    th,td{ padding:10px 8px; border-bottom:1px solid rgba(15,27,36,.1) }
    th{ text-align:left; color:#274156 }

    .page-logo { position: fixed; top: 20px; left: 24px; font-family: 'Quicksand', sans-serif; font-weight: 700; font-size: 23px; letter-spacing: 1px; color: #0f1a24; text-transform: uppercase; z-index: 10; }
    .logout-icon { position: fixed; top: 20px; right: 24px; width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; background: #fff; border: 1px solid rgba(15,27,36,.12); cursor: pointer; z-index: 10; transition: background 0.2s ease, border 0.2s ease, box-shadow .2s ease; box-shadow:0 4px 12px rgba(15,27,36,.08); }
    .logout-icon:hover { background: linear-gradient(90deg, var(--accent-a), var(--accent-b)); border-color: transparent; box-shadow:0 8px 18px rgba(0,140,255,.18); }
    .logout-icon svg { stroke: #0f1a24; transition: stroke 0.2s ease; }
    .logout-icon:hover svg { stroke: #001224; }
</style>
  /* --- Mobile HTML5 Drag & Drop helpers --- */
  [draggable="true"], .draggable{
    touch-action: none;             /* prevent scroll from swallowing drag */
    -webkit-user-drag: element;     /* Safari */
    cursor: grab;
  }
  .dragging{ opacity: .75; }
</head>
<body>
  <div class="page-logo">PROTOKOL</div>
  <div class="logout-icon" id="logoutBtn" title="Odhlásit">
    <svg viewBox="0 0 24 24" width="24" height="24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <circle cx="12" cy="12" r="9"/>
      <line x1="12" y1="7" x2="12" y2="13"/>
    </svg>
  </div>

  <div class="bg">
    <span class="blob r1"></span>
    <span class="blob r2"></span>
    <span class="blob y1"></span>
    <span class="blob y2"></span>
    <span class="blob y3"></span>
  </div>
  <div class="wrap">
    <div class="glass">
      <header>
        <div class="brand"><span class="pill">UX</span><span class="pill">UI</span><span>&nbsp;PRIORITY MAP</span></div>
        <div class="progressRow">
          <div class="circleWrap">
            <svg width="56" height="56" viewBox="0 0 56 56" aria-label="Progres">
              <defs>
                <linearGradient id="grad" x1="0%" y1="0%" x2="100%" y2="0%">
                  <stop offset="0%" stop-color="var(--accent-a)" />
                  <stop offset="100%" stop-color="var(--accent-b)" />
                </linearGradient>
              </defs>
              <circle class="circle-track" cx="28" cy="28" r="22" fill="none" stroke-width="6"/>
              <circle class="circle-bar" id="circleBar" cx="28" cy="28" r="22" fill="none" stroke-width="6" stroke-linecap="round" stroke-dasharray="138.23" stroke-dashoffset="138.23"/>
            </svg>
            <div class="pct" id="circleText">0%</div>
          </div>
          <div class="progress"><div class="bar" id="bar"></div></div>
        </div>
      </header>

      <main id="app" aria-live="polite">
        {% if stage == "auth" %}
          <div style="padding:24px">
            <h1>Nejste přihlášen</h1>
            <p class="kicker">Přejděte na <a href="/auth">/auth</a> a přihlaste se.</p>
          </div>
        {% elif stage == "likert" %}
          <div class="kicker">Položka {{ progress.index }} / {{ progress.total }}</div>
          <div class="statementBox">{{ data.text }}</div>
          <form method="POST" action="{{ url_for('priorities.answer_likert') }}">
            <input type="hidden" name="category_key" value="{{ data.category_key }}">
            <input type="hidden" name="statement_index" value="{{ data.statement_index }}">
            <div class="scale">
              {% for v in range(data.likert_min, data.likert_max + 1) %}
                <label class="choice">
                  <input type="radio" name="score" value="{{ v }}" required>
                  {{ v }}
                </label>
              {% endfor %}
            </div>
            <div class="controls">
              <span class="hint">Vyber 1 možnost</span>
              <button class="btn primary" type="submit">Pokračovat →</button>
            </div>
          </form>
        {% elif stage == "duel" %}
          <div class="kicker">Porovnání {{ progress.index }} / {{ progress.total }}</div>
          <form method="POST" action="{{ url_for('priorities.answer_duel') }}">
            <input type="hidden" name="a_key" value="{{ data.a.key }}">
            <input type="hidden" name="b_key" value="{{ data.b.key }}">
            <div class="pair">
              <button class="optionCard" type="submit" name="chosen_key" value="{{ data.a.key }}"><div class="name">🅰️ {{ data.a.label }}</div></button>
              <button class="optionCard" type="submit" name="chosen_key" value="{{ data.b.key }}"><div class="name">🅱️ {{ data.b.label }}</div></button>
            </div>
          </form>
        {% elif stage == "result" %}
  <style>header{display:none}</style>
  <div class="board">
    <!-- Box 1: Statistika FULL-WIDTH -->
    <div class="card box-stat">
      <div style="display:flex; align-items:center; justify-content:space-between; gap:16px">
        <div class="brand"><span class="pill">UX</span><span class="pill">UI</span><span>&nbsp;PRIORITY MAP</span></div>
        <div class="progressRow">
          <div class="circleWrap">
            <svg width="56" height="56" viewBox="0 0 56 56" aria-label="Progres">
              <defs>
                <linearGradient id="grad2" x1="0%" y1="0%" x2="100%" y2="0%">
                  <stop offset="0%" stop-color="var(--accent-a)" />
                  <stop offset="100%" stop-color="var(--accent-b)" />
                </linearGradient>
              </defs>
              <circle class="circle-track" cx="28" cy="28" r="22" fill="none" stroke-width="6"/>
              <circle class="circle-bar" cx="28" cy="28" r="22" fill="none" stroke="url(#grad2)" stroke-width="6" stroke-linecap="round" stroke-dasharray="138.23" stroke-dashoffset="0"/>
            </svg>
            <div class="pct">100%</div>
          </div>
          <div class="progress"><div class="bar" style="width:100%"></div></div>
        </div>
      </div>
    </div>

    <!-- Box 2: Pódium TOP3 (levý sloupec) -->
    <div class="card box-podium">
      <h1>Tvá mapa priorit</h1>
      <div class="kicker">Seřazeno podle duelů, doplněno součty z hodnocení</div>
      {% set top3 = rows[:3] %}
      <div class="top3">
        {% for r in top3 %}
        <div class="item c{{ loop.index }}">
          <div class="head">
            <span class="badge">#{{ loop.index }}</span>
            <div class="title">{{ r.category_label }}</div>
          </div>
          <p class="meta">Duely: {{ r.wins or 0 }} • Likert: {{ r.likert or 0 }}</p>
          <p class="desc">Lorem ipsum dolor sit amet, consectetur adipiscing elit. Integer nec odio. Praesent libero. Sed cursus ante dapibus diam.</p>
        </div>
        {% endfor %}
      </div>
    </div>

    <!-- Box 3: TOP 5 Drag & Drop (levý sloupec pod pódium) -->
    <div class="card box-top5">
      <h2 style="font-family:'Quicksand',sans-serif;margin:6px 0 6px">TOP 5 – přeskup si pořadí</h2>
      <ul id="top5" class="dnd"></ul>
      <div class="controls">
        <span class="hint">Chytni kartu a přetáhni. Pořadí uloží tlačítko.</span>
        <button class="btn primary" id="saveOrder" type="button">Uložit pořadí</button>
      </div>

      <style>
        .dnd{ list-style:none; padding:0; margin:12px 0; display:grid; gap:10px }
        .dnd li{ border:1px solid rgba(15,27,36,.12); border-radius:12px; padding:12px 14px; background:#fff; display:flex; align-items:center; justify-content:space-between; cursor:grab; box-shadow:0 1px 0 rgba(15,27,36,.04) }
        .dnd li:active{ cursor:grabbing }
        .handle{ opacity:.8; font-size:12px; color:#5d7b96; margin-right:8px }
        .catname{ font-family:'Quicksand',sans-serif; font-weight:800 }
        .ghost{ opacity:.6 }
      </style>
    </div>

    <!-- Box 4: Horizontální graf (pravý sloupec, pod statistikou) -->
    <div class="card box-graph">
      <style>
        .hcontrols{display:flex; gap:8px; align-items:center; margin:8px 0 12px}
        .hbtn{padding:8px 12px; border:1px solid rgba(15,27,36,.12); background:#fff; border-radius:8px; cursor:pointer; color:#0f1a24}
        .hbtn.active{background:linear-gradient(90deg, var(--accent-a), var(--accent-b)); color:#00150b; border-color:transparent}
        .hchart{display:grid; gap:10px}
        .hrow{display:grid; grid-template-columns:1fr 60px; gap:10px; align-items:center}
        .hbar{height:20px; background:rgba(15,27,36,.06); border:1px solid rgba(15,27,36,.10); border-radius:999px; position:relative; overflow:hidden}
        .hbar>span{position:absolute; inset:0 auto 0 0; width:0}
        .hbar>span::before{content:""; position:absolute; inset:0; background:linear-gradient(90deg, var(--accent-a), var(--accent-b))}
        .hbar .hlabel{position:absolute; left:12px; top:50%; transform:translateY(-50%); font-family:'Quicksand',sans-serif; font-weight:800; font-size:13px; color:#ffffff; text-shadow:0 1px 2px rgba(0,0,0,.25); white-space:nowrap}
        .hbar .hlabel.outside{ left:auto; right:-8px; color:#0f1a24; text-shadow:none; transform:translate(100%,-50%); }
        .muted{color:var(--muted); font-size:13px}
      </style>
      <div class="hcontrols">
        <button class="hbtn" data-mode="duel">Duely</button>
        <button class="hbtn" data-mode="likert">Likert</button>
        <span class="muted">Graf používá stejné pořadí a data jako tabulka (rows).</span>
      </div>
      <div id="hchart" class="hchart" aria-label="Horizontální graf priorit"></div>
    </div>
  </div>
{% endif %}
      </main>
    </div>
  </div>

  <script src="https://unpkg.com/mobile-drag-drop/default-ponyfill.min.js"></script>
  <script>
    // Enable HTML5 Drag & Drop on touch devices (iOS/Android)
    MobileDragDrop.polyfill({
      dragImageTranslateOverride: MobileDragDrop.scrollBehaviourDragImageTranslateOverride
    });
    // iOS Safari: keep DnD active by disabling passive touchmove
    window.addEventListener('touchmove', function(){}, { passive: false });
  </script>
  <script>
    const bar = document.getElementById('bar');
    const circleBar = document.getElementById('circleBar');
    const circleText = document.getElementById('circleText');
    const CIRC = 2*Math.PI*22; // 138.23
    function setProgress(pct){
      const p = Math.max(0, Math.min(100, Math.round(pct)));
      bar.style.width = p + '%';
      const offset = CIRC * (1 - p/100);
      circleBar.style.strokeDashoffset = offset;
      circleText.textContent = p + '%';
    }

    {% if stage == 'likert' %}
      setProgress(Math.round(100 * ({{ progress.index }}-1) / {{ progress.total }} ));
      // UI toggle selected style on radios
      document.querySelectorAll('.choice').forEach(label => {
        label.addEventListener('click', ()=>{
          document.querySelectorAll('.choice').forEach(l=>l.classList.remove('selected'));
          label.classList.add('selected');
        });
      });
    {% elif stage == 'duel' %}
      setProgress(Math.round(100 * ({{ progress.index }}-1) / {{ progress.total }} ));
    {% elif stage == 'result' %}
      setProgress(100);
    {% else %}
      setProgress(0);
    {% endif %}

    // logout
    const logoutBtn = document.getElementById('logoutBtn');
    if (logoutBtn){
      logoutBtn.addEventListener('click', async ()=>{
        try{ await fetch('/logout', { method:'POST' }); }catch(e){}
        location.href = '/auth';
      });
    }

    // --- Drag & Drop TOP5 ---
    {% if stage == 'result' and rows is defined %}
    (function(){
      const list = document.getElementById('top5');
      if (!list) return;

      const dataTop5 = ({{ rows[:5]|tojson }} || []).map(r => ({
        key: r.category_key || r.category,
        label: r.category_label || r.category
      }));

      list.innerHTML = dataTop5.map((r,i)=>
        `<li draggable="true" data-key="${r.key}"><span class="handle">⠿</span> <span class="catname">#${i+1} ${r.label}</span></li>`
      ).join('');

      let dragEl = null;
      list.addEventListener('dragstart', e=>{
        const li = e.target.closest('li');
        if (!li) return; dragEl = li; li.classList.add('ghost');
        e.dataTransfer.effectAllowed = 'move';
      });
      list.addEventListener('dragend', e=>{
        if (dragEl) dragEl.classList.remove('ghost');
        dragEl = null;
      });
      list.addEventListener('dragover', e=>{
        e.preventDefault();
        const after = [...list.querySelectorAll('li')].find(el => {
          const rect = el.getBoundingClientRect();
          return e.clientY < rect.top + rect.height/2;
        });
        if (after == null) list.appendChild(dragEl); else list.insertBefore(dragEl, after);
      });

      async function saveOrder(){
        const list = document.getElementById('top5');
        const btn  = document.getElementById('saveOrder');
        const order = [...list.querySelectorAll('li')].map(li => li.dataset.key);
        if (order.length !== 5) { return; }
        try{
          btn?.setAttribute('disabled','disabled');
          const r = await fetch('/priorities/reorder', {
            method:'POST',
            headers:{'Content-Type':'application/json'},
            body: JSON.stringify({order})
          });
          // i kdyz backend vrati chybu, nechceme alert – jen log do konzole
          if (!r.ok) {
            try { const j = await r.json(); console.error('Reorder error:', j); } catch(_) {}
            btn?.removeAttribute('disabled');
            return;
          }
          // uspech – okamzite refresh
          window.location.reload();
        }catch(err){
          console.error(err);
          btn?.removeAttribute('disabled');
        }
      }

      document.getElementById('saveOrder')?.addEventListener('click', saveOrder);
    })();
    // --- Horizontální graf (čte rows) ---
    (function(){
      const chart = document.getElementById('hchart');
      const btns  = Array.from(document.querySelectorAll('.hbtn'));
      if (!chart || !Array.isArray({{ rows|tojson }})) return;

      const ROWS = {{ rows|tojson }};
      const data = ROWS.map(r => ({
        key:   (r.category_key || r.category || ''),
        label: (r.category_label || r.category || ''),
        wins:  Number(r.wins || 0),
        likert:Number(r.likert || 0)
      }));

      let mode = 'duel'; // 'duel' | 'likert'

      function render(){
        const vals = data.map(d => mode==='duel' ? d.wins : d.likert);
        const max  = Math.max(1, ...vals);
        chart.innerHTML = data.map(d=>{
          const v   = mode==='duel' ? d.wins : d.likert;
          const pct = Math.round(100 * (v / max));
          return `
            <div class="hrow" data-key="${d.key}">
              <div class="hbar"><span style="width:${pct}%"><em class="hlabel${pct<20?' outside':''}">${d.label}</em></span></div>
              <div style="text-align:right">${v}</div>
            </div>
          `;
        }).join('');
      }

      function setMode(m){
        mode = m;
        btns.forEach(b => b.classList.toggle('active', b.dataset.mode === mode));
        render();
      }

      btns.forEach(b => b.addEventListener('click', () => setMode(b.dataset.mode)));
      setMode('duel'); // výchozí zobrazení
    })();
    {% endif %}
  </script>
</body>
</html>
