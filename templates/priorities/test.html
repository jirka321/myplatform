<!doctype html>
<html lang="cs">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Mapa priorit</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@500;700&family=Work+Sans:wght@400;500;600&display=swap" rel="stylesheet">
  <style>
    :root{ --text:#0f1a24; --muted:#4b6b88; --border:rgba(0,0,0,.08); --accent-a:#0090ff; --accent-b:#26b0ff; }

    html,body{height:100%}
    body{ margin:0; background:#ffffff; color:var(--text); font-family:"Work Sans", system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Arial; overflow-x:hidden; }

    .bg{ position:fixed; inset:-20vh -20vw -20vh -20vw; pointer-events:none; z-index:0; overflow:hidden; }
    .bg::before{ content:""; position:absolute; width:82vmin; height:82vmin; left:50%; top:46%; transform:translate(-50%,-50%); background:radial-gradient(circle at 50% 50%, rgba(0,185,255,.44) 0%, rgba(92,122,255,.40) 33%, rgba(255,120,200,.30) 58%, rgba(0,0,0,0) 72%); filter: blur(120px); opacity:.92; animation:none; }
    .bg::after{ content:""; position:absolute; width:48vmin; height:48vmin; left:50%; top:46%; transform:translate(-50%,-50%); background:radial-gradient(circle at 50% 50%, rgba(255,255,255,.80) 0%, rgba(255,255,255,.0) 60%); filter: blur(30px); opacity:.9; animation:none; }
    @keyframes pulse { 0%{transform:scale(1);opacity:.95;filter:blur(90px)} 50%{transform:scale(1.15);opacity:.85;filter:blur(120px)} 100%{transform:scale(1);opacity:.95;filter:blur(90px)} }
    @keyframes drift { 0%{transform:translate3d(-2vw,-2vh,0) scale(1)} 50%{transform:translate3d(2vw,1vh,0) scale(1.08)} 100%{transform:translate3d(-2vw,-2vh,0) scale(1)} }

    .blob{ position:absolute; border-radius:50%; filter: blur(110px); transform: translateZ(0); opacity:.18; }
    .blob.r1{ width:64vmin; height:64vmin; left:calc(50% - 44vmin); top:calc(50% - 18vmin); background:radial-gradient(circle at 50% 50%, rgba(255,80,80,0.55) 0%, rgba(255,80,80,0.22) 45%, rgba(255,80,80,0) 72%); animation: drift 14s ease-in-out infinite; }
    .blob.r2{ width:50vmin; height:50vmin; left:calc(50% + 24vmin); top:calc(50% - 26vmin); background:radial-gradient(circle at 50% 50%, rgba(255,120,120,0.50) 0%, rgba(255,120,120,0.20) 45%, rgba(255,120,120,0) 72%); animation: pulse 10s ease-in-out infinite; }
    .blob.y1{ width:70vmin; height:70vmin; left:calc(50% - 28vmin); top:calc(50% + 24vmin); background:radial-gradient(circle at 50% 50%, rgba(255,210,0,0.54) 0%, rgba(255,210,0,0.20) 45%, rgba(255,210,0,0) 72%); animation: drift 16s ease-in-out infinite; }
    .blob.y2{ width:48vmin; height:48vmin; left:calc(50% + 22vmin); top:calc(50% + 10vmin); background:radial-gradient(circle at 50% 50%, rgba(255,180,0,0.52) 0%, rgba(255,180,0,0.20) 45%, rgba(255,180,0,0) 72%); animation: pulse 12s ease-in-out infinite; }
    .blob.y3{ width:40vmin; height:40vmin; left:50%; top:50%; transform:translate(-50%,-50%); background:radial-gradient(circle at 50% 50%, rgba(255,230,90,0.50) 0%, rgba(255,230,90,0.18) 45%, rgba(255,230,90,0) 72%); animation: drift 11s ease-in-out infinite; }

    .wrap{ position:relative; z-index:1; min-height:100%; display:flex; align-items:center; justify-content:center; padding:6vh 4vw; }
    .glass{ width:min(1180px, 100%); border-radius:20px; background: transparent; border: none; box-shadow: none; backdrop-filter: none; -webkit-backdrop-filter: none; }
    .card{ padding:18px 20px; border:1px solid rgba(255,255,255,.35); border-radius:18px; background:rgba(255,255,255,.55); box-shadow:0 8px 22px rgba(15,27,36,.07); backdrop-filter: blur(16px) saturate(140%); -webkit-backdrop-filter: blur(16px) saturate(140%); }

    header{ display:flex; align-items:center; justify-content:space-between; gap:16px; padding:18px 22px; border-bottom:1px solid var(--border) }
    .brand{ display:flex; align-items:center; gap:10px; font-family:'Quicksand', sans-serif; font-weight:800; letter-spacing:.4px; }
    .pill{ border:1px solid rgba(0,120,255,.18); background:rgba(0,120,255,.08); border-radius:999px; padding:6px 12px; font-size:12px; color:#0f3555; }

    .progressRow{ display:flex; align-items:center; gap:14px; }
    .circleWrap{ position:relative; width:56px; height:56px; }
    .circleWrap svg{ transform:rotate(-90deg); overflow:visible; background:transparent; display:block; }
    .circle-track{ stroke: rgba(15,27,36,.12); }
    .circle-bar{ stroke: var(--accent-a); transition: stroke-dashoffset .3s ease; }
    .circleWrap .pct{ position:absolute; inset:0; display:grid; place-items:center; font-family:'Quicksand', sans-serif; font-weight:800; font-size:12px; color:#274156; transform:translateZ(0); }

    .progress{ flex:1; height:8px; background:rgba(15,27,36,.06); border:1px solid rgba(15,27,36,.08); border-radius:999px; overflow:hidden; }
    .bar{ height:100%; width:0%; background:linear-gradient(90deg, var(--accent-a), var(--accent-b)); box-shadow: 0 4px 18px rgba(0,140,255,.35); transition:width .3s ease; }

    main{ padding:20px 26px 28px }
    h1{ font-family:'Quicksand', sans-serif; margin:0 0 6px; font-size:28px }
    .kicker{ color:var(--muted); font-size:14px; margin-bottom:12px }
    .statementBox{ font-size:20px; font-weight:700; line-height:1.35; padding:18px; border:1px solid rgba(15,27,36,.10); border-radius:14px; background:linear-gradient(180deg, rgba(255,255,255,.9), rgba(255,255,255,.75)); color:#0f1a24; }

    .scale{ display:grid; grid-template-columns:repeat(4,1fr); gap:12px; margin-top:14px }
    .choice{ border:1px solid rgba(15,27,36,.10); border-radius:12px; padding:14px 12px; text-align:center; font-weight:700; cursor:pointer; user-select:none; background:#ffffff; color:#0f1a24; transition:transform .08s ease, box-shadow .12s ease, border-color .12s ease; box-shadow:0 1px 0 rgba(15,27,36,.04); }
    .choice:hover{ border-color:rgba(0,140,255,.35); box-shadow:0 4px 14px rgba(0,140,255,.08); transform:translateY(-1px); }
    .choice input{ display:none }
    .choice.selected{ border-color:rgba(0,140,255,.55); background:linear-gradient(180deg, rgba(0,140,255,.10), rgba(0,140,255,.06)); color:#0f3555 }

    .controls{ display:flex; align-items:center; justify-content:space-between; gap:12px; margin-top:16px }
    .hint{ color:var(--muted); font-size:13px }
    .btn{ border:none; padding:12px 18px; border-radius:999px; font-family:'Quicksand', sans-serif; font-weight:800; cursor:pointer; }
    .btn.primary{ color:#00150b; background:linear-gradient(90deg, var(--accent-a), var(--accent-b)); }
    .btn.secondary{ background:#fff; border:1px solid rgba(15,27,36,.12); color:#0f1a24 }

    .pair{ display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-top:14px }
    .optionCard{ border:1px solid rgba(15,27,36,.10); border-radius:14px; padding:16px; cursor:pointer; background:#fff; transition:box-shadow .12s ease, border-color .12s ease, transform .08s ease; }
    .optionCard:hover{ border-color:rgba(0,140,255,.35); box-shadow:0 6px 20px rgba(0,140,255,.08); transform:translateY(-1px); }
    .optionCard .name{ font-weight:800; color:#0f1a24 }

    .summary{ display:grid; gap:18px; grid-template-columns: 2fr 1.1fr; align-items:start }
    .summary > div:nth-child(2){ position:sticky; top:24px }
    @media (max-width: 1100px){
      .summary{ grid-template-columns: 1fr; }
      .summary > div:nth-child(2){ position:static; }
    }
    .board{ display:grid; grid-template-columns: 2fr 1.1fr; gap:18px; align-items:start; grid-template-areas:
      "stat stat"
      "pod  graph"
      "top5 graph"; }
    .box-stat{ grid-area: stat; }
    .box-podium{ grid-area: pod; }
    .box-top5{ grid-area: top5; }
    .box-graph{ grid-area: graph; position:sticky; top:24px }
    @media (max-width:1100px){
      .board{ grid-template-columns:1fr; grid-template-areas:
        "stat"
        "graph"
        "pod"
        "top5"; }
      .box-graph{ position:static }
    }
    .podium{ display:grid; grid-template-columns: 1fr 1fr 1fr; gap:12px; align-items:end; }
    .top3{ display:grid; grid-template-columns: repeat(3, 1fr); gap:12px; }
    .top3 .item{ position:relative; border:1px solid rgba(15,27,36,.10); border-radius:18px; padding:16px; background:#ffffff; box-shadow:none; }
    .top3 .item .head{ display:flex; align-items:center; gap:10px; margin-bottom:6px }
    .top3 .item .badge{ display:inline-grid; place-items:center; width:34px; height:34px; border-radius:50%; font-family:'Quicksand',sans-serif; font-weight:800; font-size:13px; color:#00150b; background:linear-gradient(90deg, var(--accent-a), var(--accent-b)); box-shadow:0 6px 16px rgba(0,140,255,.25) }
    .top3 .item .title{ font-family:'Quicksand',sans-serif; font-weight:800; font-size:16px }
    .top3 .item .meta{ color:#4b6b88; font-size:12px; margin:6px 0 8px }
    .top3 .item .desc{ font-size:13px; line-height:1.35; color:#0f1a24 }
    .top3 .item.c1{ background:#eaf5ff; border-color: rgba(0,144,255,.20) }
    .top3 .item.c2{ background:#e9fbf6; border-color: rgba(0,200,170,.20) }
    .top3 .item.c3{ background:#fff6e0; border-color: rgba(255,180,0,.22) }
    @media (max-width:900px){ .top3{ grid-template-columns: 1fr } }
    .col{ position:relative; background:#fff; border:1px solid rgba(15,27,36,.10); border-radius:12px; height:var(--h,120px); display:grid; place-items:center; box-shadow:0 3px 10px rgba(15,27,36,.05) }
    .rank{ position:absolute; top:6px; left:8px; font-weight:800; font-family:'Quicksand', sans-serif; font-size:12px; color:#0b61d6 }
    .name{ font-weight:800; font-family:'Quicksand', sans-serif; text-align:center; color:#0f1a24 }
    table{ width:100%; border-collapse:collapse; margin-top:10px; font-size:14px; color:#0f1a24 }
    th,td{ padding:10px 8px; border-bottom:1px solid rgba(15,27,36,.1) }
    th{ text-align:left; color:#274156 }

    .page-logo { position: fixed; top: 20px; left: 24px; font-family: 'Quicksand', sans-serif; font-weight: 700; font-size: 23px; letter-spacing: 1px; color: #0f1a24; text-transform: uppercase; z-index: 10; }

    .profile{ position: fixed; top: 20px; right: 24px; z-index: 20; padding-bottom: 12px; }
    .profile-btn{ width:40px; height:40px; border-radius:50%; display:flex; align-items:center; justify-content:center; background:#fff; border:1px solid rgba(15,27,36,.12); cursor:pointer; transition: background .2s ease, border .2s ease, box-shadow .2s ease; box-shadow:0 4px 12px rgba(15,27,36,.08); }
    .profile-btn:hover{ background: linear-gradient(90deg, var(--accent-a), var(--accent-b)); border-color: transparent; box-shadow:0 8px 18px rgba(0,140,255,.18); }
    .profile-btn svg{ stroke:#0f1a24; transition: stroke .2s ease; }
    .profile-btn:hover svg{ stroke:#001224; }
    .menu{ position:absolute; right:0; top:44px; width:220px; border:1px solid rgba(15,27,36,.12); background:#fff; border-radius:12px; box-shadow:0 12px 24px rgba(15,27,36,.16); padding:8px; display:none; }
    .profile:hover .menu{ display:block; }
    .menu.open{ display:block; } /* touch fallback via JS */
    .menu .sep{ height:1px; background:linear-gradient(90deg, rgba(15,27,36,.06), rgba(15,27,36,.12), rgba(15,27,36,.06)); margin:6px 6px; border-radius:1px; }
    .menu h4{ margin:4px 8px 8px; font-family:'Quicksand',sans-serif; font-size:12px; letter-spacing:.4px; color:#274156; }
    .menu .item{ display:flex; align-items:center; gap:10px; padding:10px 10px; border-radius:10px; cursor:pointer; text-decoration:none; color:#0f1a24; border:1px solid transparent; }
    .menu .item:hover{ background:linear-gradient(180deg, rgba(0,140,255,.07), rgba(0,140,255,.02)); border-color: rgba(0,140,255,.18); }
    .menu .item svg{ width:18px; height:18px; stroke:#0f1a24; }
    .menu form{ margin:0; }
    .hbtn{padding:8px 12px; border:1px solid rgba(15,27,36,.12); background:#fff; border-radius:8px; cursor:pointer; color:#0f1a24}
    .hbtn.active{background:linear-gradient(90deg, var(--accent-a), var(--accent-b)); color:#00150b; border-color:transparent}
    .mini-choices{ display:flex; gap:6px; }
    .mini-choices .hbtn{ min-width:36px; text-align:center; padding:8px 10px; }
    .mini-choices .hbtn.active{ pointer-events:none; opacity:.9 }
    .mini-choices .hbtn.disabled{ opacity:.45; cursor:not-allowed; }
    .review-card{ border:1px solid rgba(15,27,36,.12); border-radius:12px; padding:10px 12px; margin-bottom:10px; background:#fff; }
    .review-text{ font-size:13px; color:#274156; margin-bottom:6px }
  </style>
  <style>
    /* --- Mobile HTML5 Drag & Drop helpers --- */
    [draggable="true"], .draggable{
      touch-action: none;             /* prevent scroll from swallowing drag */
      -webkit-user-drag: element;     /* Safari */
      cursor: grab;
    }
    .dragging{ opacity: .75; }
  </style>
</head>
<body>
  <div class="page-logo">PROTOKOL</div>
  <div class="profile" id="profile">
    <button class="profile-btn" id="profileBtn" aria-haspopup="true" aria-expanded="false" aria-controls="profileMenu" title="Profil">
      <svg viewBox="0 0 24 24" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
        <circle cx="12" cy="8" r="4"/>
        <path d="M4 20c0-4 4-6 8-6s8 2 8 6"/>
      </svg>
    </button>
    <div class="menu" id="profileMenu" role="menu" aria-label="Profil">
      <h4>Uživatel</h4>
      <form method="POST" action="{{ url_for('priorities.restart_priorities') }}">
        <button class="item" type="submit" role="menuitem">
          <svg viewBox="0 0 24 24" fill="none"><path d="M12 5v6m0 0l-2-2m2 2l2-2" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
          Začít znovu
        </button>
      </form>
      <div class="sep"></div>
      <form method="POST" action="/auth">
        <button class="item" type="submit" role="menuitem">
          <svg viewBox="0 0 24 24" fill="none"><path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4M10 17l5-5-5-5M15 12H3" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
          Odhlásit
        </button>
      </form>
    </div>
  </div>

  <div class="bg">
    <span class="blob r1"></span>
    <span class="blob r2"></span>
    <span class="blob y1"></span>
    <span class="blob y2"></span>
    <span class="blob y3"></span>
  </div>
  <div class="wrap">
    <div class="glass">
      <header>
        <div class="brand"><span class="pill">UX</span><span class="pill">UI</span><span>&nbsp;PRIORITY MAP</span></div>
        <div class="progressRow">
          <div class="circleWrap">
            <svg width="56" height="56" viewBox="0 0 56 56" aria-label="Progres">
              <circle class="circle-track" cx="28" cy="28" r="22" fill="none" stroke-width="6"/>
              <circle class="circle-bar" id="circleBar" cx="28" cy="28" r="22" fill="none" stroke-width="6" stroke-linecap="round" stroke-dasharray="138.23" stroke-dashoffset="138.23"/>
            </svg>
            <div class="pct" id="circleText">0%</div>
          </div>
          <div class="circleWrap" aria-label="Zbývající body">
            <svg width="56" height="56" viewBox="0 0 56 56">
              <circle class="circle-track" cx="28" cy="28" r="22" fill="none" stroke-width="6"/>
              <circle class="circle-bar" id="budgetCircleBar" cx="28" cy="28" r="22" fill="none" stroke-width="6" stroke-linecap="round" stroke-dasharray="138.23" stroke-dashoffset="138.23"/>
            </svg>
            <div class="pct" id="budgetCircleText">…</div>
          </div>
          <div class="progress"><div class="bar" id="bar"></div></div>
        </div>
      </header>

      <main id="app" aria-live="polite">
        {% if stage == "auth" %}
          <div style="padding:24px">
            <h1>Nejste přihlášen</h1>
            <p class="kicker">Přejděte na <a href="/auth">/auth</a> a přihlaste se.</p>
          </div>
        {% elif stage == "likert" %}
          <div class="kicker">Položka {{ progress.index }} / {{ progress.total }}</div>
          <div class="statementBox">{{ data.text }}</div>
          <form id="likertForm" method="POST" action="{{ url_for('priorities.answer_likert') }}">
            <input type="hidden" name="category_key" value="{{ data.category_key }}">
            <input type="hidden" name="statement_index" value="{{ data.statement_index }}">
            <div class="scale">
              {% for v in range(data.likert_min, data.likert_max + 1) %}
                <label class="choice">
                  <input type="radio" name="score" value="{{ v }}" required>
                  {{ v }}
                </label>
              {% endfor %}
            </div>
            <div class="controls">
              <span class="hint">Vyber 1 možnost</span>
              <button class="btn secondary" type="button" id="openReview" style="display:none">Upravit odpovědi</button>
              <button class="btn primary" type="submit">Pokračovat →</button>
            </div>
          </form>
          <div id="budgetBanner" class="kicker" style="display:none; margin-top:8px; color:#8a3b00">
            Nemáš dost bodů pro vyšší volbu. Sniž něco v dřívějších odpovědích – otevři „Upravit odpovědi“.
          </div>
        {% elif stage == "duel" %}
          <div class="kicker">Porovnání {{ progress.index }} / {{ progress.total }}</div>
          <form method="POST" action="{{ url_for('priorities.answer_duel') }}">
            <input type="hidden" name="a_key" value="{{ data.a.key }}">
            <input type="hidden" name="b_key" value="{{ data.b.key }}">
            <div class="pair">
              <button class="optionCard" type="submit" name="chosen_key" value="{{ data.a.key }}"><div class="name">🅰️ {{ data.a.label }}</div></button>
              <button class="optionCard" type="submit" name="chosen_key" value="{{ data.b.key }}"><div class="name">🅱️ {{ data.b.label }}</div></button>
            </div>
          </form>
        {% elif stage == "result" %}
  <style>header{display:none}</style>
  <div class="board">
    <!-- Box 1: Statistika FULL-WIDTH -->
    <div class="card box-stat">
      <div style="display:flex; align-items:center; justify-content:space-between; gap:16px">
        <div class="brand"><span class="pill">UX</span><span class="pill">UI</span><span>&nbsp;PRIORITY MAP</span></div>
        <div class="progressRow">
          <div class="circleWrap">
            <svg width="56" height="56" viewBox="0 0 56 56" aria-label="Progres">
              <circle class="circle-track" cx="28" cy="28" r="22" fill="none" stroke-width="6"/>
              <circle class="circle-bar" cx="28" cy="28" r="22" fill="none" stroke-width="6" stroke-linecap="round" stroke-dasharray="138.23" stroke-dashoffset="0"/>
            </svg>
            <div class="pct">100%</div>
          </div>
          <div class="progress"><div class="bar" style="width:100%"></div></div>
        </div>
      </div>
    </div>

    <!-- Box 2: Pódium TOP3 (levý sloupec) -->
    <div class="card box-podium">
      <h1>Tvá mapa priorit</h1>
      <div class="kicker">Seřazeno podle duelů, doplněno součty z hodnocení</div>
      {% set top3 = rows[:3] %}
      <div class="top3">
        {% for r in top3 %}
        <div class="item c{{ loop.index }}">
          <div class="head">
            <span class="badge">#{{ loop.index }}</span>
            <div class="title">{{ r.category_label }}</div>
          </div>
          <p class="meta">Duely: {{ r.wins or 0 }} • Likert: {{ r.likert or 0 }}</p>
          <p class="desc">Lorem ipsum dolor sit amet, consectetur adipiscing elit. Integer nec odio. Praesent libero. Sed cursus ante dapibus diam.</p>
        </div>
        {% endfor %}
      </div>
    </div>

    <!-- Box 3: TOP 5 Drag & Drop (levý sloupec pod pódium) -->
    <div class="card box-top5">
      <h2 style="font-family:'Quicksand',sans-serif;margin:6px 0 6px">TOP 5 – přeskup si pořadí</h2>
      <ul id="top5" class="dnd"></ul>
      <div class="controls">
        <span class="hint">Chytni kartu a přetáhni. Pořadí uloží tlačítko.</span>
        <button class="btn primary" id="saveOrder" type="button">Uložit pořadí</button>
      </div>

      <style>
        .dnd{ list-style:none; padding:0; margin:12px 0; display:grid; gap:10px }
        .dnd li{ border:1px solid rgba(15,27,36,.12); border-radius:12px; padding:12px 14px; background:#fff; display:flex; align-items:center; justify-content:space-between; cursor:grab; box-shadow:0 1px 0 rgba(15,27,36,.04) }
        .dnd li:active{ cursor:grabbing }
        .handle{ opacity:.8; font-size:12px; color:#5d7b96; margin-right:8px }
        .catname{ font-family:'Quicksand',sans-serif; font-weight:800 }
        .ghost{ opacity:.6 }
      </style>
    </div>

    <!-- Box 4: Horizontální graf (pravý sloupec, pod statistikou) -->
    <div class="card box-graph">
      <style>
        .hcontrols{display:flex; gap:8px; align-items:center; margin:8px 0 12px}
        .hbtn{padding:8px 12px; border:1px solid rgba(15,27,36,.12); background:#fff; border-radius:8px; cursor:pointer; color:#0f1a24}
        .hbtn.active{background:linear-gradient(90deg, var(--accent-a), var(--accent-b)); color:#00150b; border-color:transparent}
        .hchart{display:grid; gap:10px}
        .hrow{display:grid; grid-template-columns:1fr 60px; gap:10px; align-items:center}
        .hbar{height:20px; background:rgba(15,27,36,.06); border:1px solid rgba(15,27,36,.10); border-radius:999px; position:relative; overflow:hidden}
        .hbar>span{position:absolute; inset:0 auto 0 0; width:0}
        .hbar>span::before{content:""; position:absolute; inset:0; background:linear-gradient(90deg, var(--accent-a), var(--accent-b))}
        .hbar .hlabel{position:absolute; left:12px; top:50%; transform:translateY(-50%); font-family:'Quicksand',sans-serif; font-weight:800; font-size:13px; color:#ffffff; text-shadow:0 1px 2px rgba(0,0,0,.25); white-space:nowrap}
        .hbar .hlabel.outside{ left:auto; right:-8px; color:#0f1a24; text-shadow:none; transform:translate(100%,-50%); }
        .muted{color:var(--muted); font-size:13px}
      </style>
      <div class="hcontrols">
        <button class="hbtn" data-mode="duel">Duely</button>
        <button class="hbtn" data-mode="likert">Likert</button>
        <span class="muted">Graf používá stejné pořadí a data jako tabulka (rows).</span>
      </div>
      <div id="hchart" class="hchart" aria-label="Horizontální graf priorit"></div>
    </div>
  </div>
{% endif %}
      </main>
    </div>
  </div>

  <!-- Modal: Upravit odpovědi -->
  <div id="reviewModal" aria-hidden="true" style="display:none; position:fixed; inset:0; z-index:80;">
    <div id="reviewBackdrop" style="position:absolute; inset:0; background:rgba(15,27,36,.42); backdrop-filter: blur(4px);"></div>
    <div role="dialog" aria-modal="true" aria-labelledby="reviewTitle"
         style="position:absolute; left:50%; top:52%; transform:translate(-50%,-50%); width:min(880px, 92vw); max-height:86vh; overflow:auto; background:#fff; border:1px solid rgba(15,27,36,.12); border-radius:16px; box-shadow:0 24px 60px rgba(0,0,0,.22);">
      <div style="position:sticky; top:0; background:#fff; padding:14px 16px; border-bottom:1px solid rgba(15,27,36,.08); display:flex; gap:10px; align-items:center; justify-content:space-between">
        <div style="display:flex; align-items:center; gap:10px">
          <h3 id="reviewTitle" style="margin:0; font-family:'Quicksand',sans-serif">Upravit odpovědi</h3>
          <span class="pill" id="modalBudget">Zbývá: …</span>
          <span class="pill" id="modalItems">Položek: …</span>
        </div>
        <div style="display:flex; gap:6px">
          <button class="hbtn" data-filter="all" id="fltAll">Vše</button>
          <button class="hbtn active" data-filter="costly" id="fltCostly">4 &amp; 3</button>
          <button class="hbtn" data-filter="recent" id="fltRecent">Nejnovější</button>
        </div>
      </div>
      <div id="reviewList" style="padding:12px 16px"></div>
      <div style="position:sticky; bottom:0; background:#fff; padding:12px 16px; border-top:1px solid rgba(15,27,36,.08); display:flex; justify-content:flex-end; gap:8px">
        <button class="btn secondary" id="closeReview">Zavřít</button>
        <button class="btn primary" id="continueReview">Pokračovat</button>
      </div>
    </div>
  </div>
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.2/Sortable.min.js"></script>
  <script>
    const bar = document.getElementById('bar');
    const circleBar = document.getElementById('circleBar');
    const circleText = document.getElementById('circleText');
    const CIRC = 2*Math.PI*22; // 138.23
    function setProgress(pct){
      const p = Math.max(0, Math.min(100, Math.round(pct)));
      bar.style.width = p + '%';
      const offset = CIRC * (1 - p/100);
      circleBar.style.strokeDashoffset = offset;
      circleText.textContent = p + '%';
    }

    {% if stage == 'likert' %}
      setProgress(Math.round(100 * ({{ progress.index }}-1) / {{ progress.total }} ));
      // UI toggle selected style on radios
      document.querySelectorAll('.choice').forEach(label => {
        label.addEventListener('click', ()=>{
          document.querySelectorAll('.choice').forEach(l=>l.classList.remove('selected'));
          label.classList.add('selected');
        });
      });
      // --- Budget settings (1→1, 4→4), modal-based review ---
      const REVIEW_URL = "{{ url_for('priorities.review_answers') }}";
      const ADJUST_URL = "{{ url_for('priorities.adjust_answer') }}";
      const POOL = 280;
      const LIKERT_MIN = {{ data.likert_min|default(1) }};
      const LIKERT_MAX = {{ data.likert_max|default(4) }};
      const idx = {{ progress.index }}; 
      const total = {{ progress.total }};
      const itemsInfo = document.getElementById('itemsInfo');
      const budgetInfo = document.getElementById('budgetInfo'); // may be null now
      const budgetBanner = document.getElementById('budgetBanner');
      const openReviewBtn = document.getElementById('openReview');
      const budgetCircleBar = document.getElementById('budgetCircleBar');
      const budgetCircleText = document.getElementById('budgetCircleText');
      let REMAINING = null; // global cache of remaining points

      function setItemsLeft(){
        const left = Math.max(0, total - (idx - 1));
        if (itemsInfo) itemsInfo.textContent = `Položek: ${left}`;
        const modalItems = document.getElementById('modalItems');
        if (modalItems) modalItems.textContent = `Položek: ${left}`;
      }

      async function fetchRemaining(){
        try{
          const r = await fetch(REVIEW_URL);
          if (!r.ok) throw new Error('status '+r.status);
          const j = await r.json();
          const rem = Number(j.remaining);
          if (!Number.isFinite(rem)) throw new Error('bad payload');
          updateRemaining(rem);
          return { data: j };
        }catch(e){
          // fallback: unknown
          updateRemaining(null);
          return { data: { items: [] } };
        }
      }

      function updateRemaining(rem){
        REMAINING = rem;
        // Update old pill if still present (harmless if removed)
        const txt = (rem==null) ? 'Zbývá: …' : `Zbývá: ${rem}`;
        if (budgetInfo) budgetInfo.textContent = txt;
        const modalBudget = document.getElementById('modalBudget');
        if (modalBudget) modalBudget.textContent = txt;
        // Toggle banner and review button when out of budget
        const out = (rem!=null && rem <= 0);
        if (budgetBanner) budgetBanner.style.display = out ? 'block' : 'none';
        if (openReviewBtn) openReviewBtn.style.display = out ? 'inline-block' : 'none';
        // Drive the budget circle (shrinks as body ubývají)
        if (typeof rem === 'number' && budgetCircleBar && budgetCircleText){
          const p = Math.max(0, Math.min(100, Math.round( (rem / POOL) * 100 )));
          const offset = CIRC * (1 - p/100);
          budgetCircleBar.style.strokeDashoffset = offset;
          budgetCircleText.textContent = String(rem);
        } else if (budgetCircleText) {
          budgetCircleText.textContent = '…';
        }
        lockChoicesByRemaining(rem);
      }

      function lockChoicesByRemaining(rem){
        if (rem==null) return; // no locking if unknown
        document.querySelectorAll('.choice').forEach(label=>{
          const input = label.querySelector('input[type="radio"]');
          const v = Number(input?.value || 0);
          // na aktuální otázce předpokládáme, že stará hodnota je 0 (nevyplněno)
          const dis = v > rem;
          input.disabled = dis;
          label.classList.toggle('disabled', dis);
        });
      }

      // Modal wiring
      const modal = document.getElementById('reviewModal');
      const backdrop = document.getElementById('reviewBackdrop');
      const reviewList = document.getElementById('reviewList');
      const fltAll = document.getElementById('fltAll');
      const fltCostly = document.getElementById('fltCostly');
      const fltRecent = document.getElementById('fltRecent');

      function openModal(){ modal.style.display = 'block'; modal.setAttribute('aria-hidden','false'); }
      function closeModal(){ modal.style.display = 'none'; modal.setAttribute('aria-hidden','true'); }

      async function loadReview(filter='costly'){
        const qs = (filter==='costly') ? '?costly=1' : '';
        const r = await fetch(REVIEW_URL+qs);
        const j = await r.json().catch(()=>({items:[], remaining:null}));
        updateRemaining(Number(j.remaining));
        renderReviewItems(j.items || [], filter);
      }

      function renderReviewItems(items, filter){
        if (filter==='recent'){
          items = [...items].sort((a,b)=> (b.updated_at||0) - (a.updated_at||0));
        }
        reviewList.innerHTML = (items||[]).map(it=>{
          const buttons = Array.from({length: LIKERT_MAX-LIKERT_MIN+1}, (_,i)=> i+LIKERT_MIN)
            .map(v=>`<button class="hbtn ${v===Number(it.value)?'active':''}" data-qid="${it.q_id}" data-val="${v}">${v}</button>`).join('');
          return `
            <div class="review-card">
              <div class="review-text">${it.text||''}</div>
              <div class="mini-choices" data-qid="${it.q_id}">${buttons}</div>
            </div>
          `;
        }).join('') || '<div class="kicker">Zatím tu nic není.</div>';
        syncDisableInModal(); // disable volby nad rámec zbývajících bodů
      }

      function syncDisableInModal(){
        const rem = (typeof REMAINING === 'number') ? REMAINING : null;
        if (!Number.isFinite(rem)) return;
        reviewList.querySelectorAll('.mini-choices').forEach(wrap=>{
          const active = wrap.querySelector('.hbtn.active');
          const currVal = Number(active?.dataset.val || 0);
          wrap.querySelectorAll('.hbtn').forEach(btn=>{
            const v = Number(btn.dataset.val);
            const delta = v - currVal;
            const dis = delta > rem; // zvýšení přes limit nedovolíme
            btn.classList.toggle('disabled', dis);
            btn.disabled = dis;
          });
        });
      }

      reviewList?.addEventListener('click', async (e)=>{
        const btn = e.target.closest('.hbtn');
        if (!btn || btn.classList.contains('active') || btn.classList.contains('disabled')) return;
        const qid = btn.dataset.qid; // composite id "category|index"
        const val = Number(btn.dataset.val);
        try{
          const r = await fetch(ADJUST_URL, {
            method:'POST',
            headers:{'Content-Type':'application/json'},
            body: JSON.stringify({ q_id: qid, new_value: val })
          });
          const j = await r.json();
          if (!r.ok){
            if (typeof j.remaining === 'number') updateRemaining(j.remaining);
            return;
          }
          updateRemaining(Number(j.remaining));
          // toggle active in group
          const group = btn.parentElement;
          group.querySelectorAll('.hbtn').forEach(b=>b.classList.toggle('active', b===btn));
          syncDisableInModal();
        }catch(err){ console.error(err); }
      });

      // open/close modal controls
      openReviewBtn?.addEventListener('click', ()=>{
        openModal();
        loadReview('costly').catch(()=>{});
      });
      // Intercept submit: if no radio selected or out of budget, open modal instead of posting empty form
      const likertForm = document.getElementById('likertForm');
      likertForm?.addEventListener('submit', (e)=>{
        const chosen = likertForm.querySelector('input[name="score"]:checked');
        const rem = (typeof REMAINING === 'number') ? REMAINING : null;
        if (!chosen || (typeof rem === 'number' && rem <= 0)){
          e.preventDefault();
          openModal();
          loadReview('costly').catch(()=>{});
        }
      });
      document.addEventListener('click', (e)=>{
        const t = e.target && e.target.closest && e.target.closest('#openReview');
        if (!t) return;
        openModal();
        loadReview('costly').catch(()=>{});
      });
      document.getElementById('continueReview')?.addEventListener('click', ()=>{
        closeModal();
      });
      document.getElementById('closeReview')?.addEventListener('click', closeModal);
      backdrop?.addEventListener('click', closeModal);

      // filter buttons
      function setFilter(which){
        [fltAll, fltCostly, fltRecent].forEach(b=>b?.classList.toggle('active', b?.dataset.filter===which));
        loadReview(which);
      }
      fltAll?.addEventListener('click', ()=>setFilter('all'));
      fltCostly?.addEventListener('click', ()=>setFilter('costly'));
      fltRecent?.addEventListener('click', ()=>setFilter('recent'));

      // initial sync
      setItemsLeft();
      fetchRemaining();
    {% elif stage == 'duel' %}
      setProgress(Math.round(100 * ({{ progress.index }}-1) / {{ progress.total }} ));
    {% elif stage == 'result' %}
      setProgress(100);
    {% else %}
      setProgress(0);
    {% endif %}

    // profile menu: open on hover (desktop), click fallback on touch
    (function(){
      const root = document.getElementById('profile');
      const btn  = document.getElementById('profileBtn');
      const menu = document.getElementById('profileMenu');
      if (!root || !btn || !menu) return;

      let hideTimer = null;
      function openMenu(){ menu.classList.add('open'); btn.setAttribute('aria-expanded','true'); }
      function closeMenu(){ menu.classList.remove('open'); btn.setAttribute('aria-expanded','false'); }
      function scheduleClose(){ clearTimeout(hideTimer); hideTimer = setTimeout(closeMenu, 160); }
      function cancelClose(){ clearTimeout(hideTimer); }

      const isTouch = window.matchMedia && window.matchMedia('(hover: none)').matches;

      function setExpanded(v){ btn.setAttribute('aria-expanded', String(v)); }

      if (!isTouch){
        // Desktop: open on hover with delay, keep open while hovering menu
        root.addEventListener('mouseenter', ()=>{ cancelClose(); openMenu(); });
        root.addEventListener('mouseleave', scheduleClose);
        menu.addEventListener('mouseenter', cancelClose);
        menu.addEventListener('mouseleave', scheduleClose);
        document.addEventListener('keydown', (e)=>{ if (e.key === 'Escape'){ cancelClose(); closeMenu(); }});
      } else {
        // Touch devices: toggle on tap
        btn.addEventListener('click', (e)=>{
          e.stopPropagation();
          const willOpen = !menu.classList.contains('open');
          menu.classList.toggle('open', willOpen);
          setExpanded(willOpen);
        });
        document.addEventListener('click', (e)=>{
          if (!root.contains(e.target)){ menu.classList.remove('open'); setExpanded(false); }
        });
      }
    })();

    // --- Drag & Drop TOP5 ---
    {% if stage == 'result' and rows is defined %}
    (function(){
      const list = document.getElementById('top5');
      if (!list) return;

      const dataTop5 = ({{ rows[:5]|tojson }} || []).map(r => ({
        key: r.category_key || r.category,
        label: r.category_label || r.category
      }));

      list.innerHTML = dataTop5.map((r,i)=>
        `<li data-key="${r.key}"><span class="handle">⠿</span> <span class="catname">#${i+1} ${r.label}</span></li>`
      ).join('');

      // Touch-friendly DnD across desktop & mobile
      const sortable = new Sortable(list, {
        animation: 150,
        handle: '.handle',
        ghostClass: 'ghost',
        dragClass: 'dragging',
        forceFallback: true,
        fallbackOnBody: true,
        touchStartThreshold: 3
      });

      async function saveOrder(){
        const list = document.getElementById('top5');
        const btn  = document.getElementById('saveOrder');
        const order = [...list.querySelectorAll('li')].map(li => li.dataset.key);
        if (order.length !== 5) { return; }
        try{
          btn?.setAttribute('disabled','disabled');
          const r = await fetch("{{ url_for('priorities.reorder_top5') }}", {
            method:'POST',
            headers:{'Content-Type':'application/json'},
            body: JSON.stringify({order})
          });
          // i kdyz backend vrati chybu, nechceme alert – jen log do konzole
          if (!r.ok) {
            try { const j = await r.json(); console.error('Reorder error:', j); } catch(_) {}
            btn?.removeAttribute('disabled');
            return;
          }
          // uspech – okamzite refresh
          window.location.reload();
        }catch(err){
          console.error(err);
          btn?.removeAttribute('disabled');
        }
      }

      document.getElementById('saveOrder')?.addEventListener('click', saveOrder);
    })();
    // --- Horizontální graf (čte rows) ---
    (function(){
      const chart = document.getElementById('hchart');
      const btns  = Array.from(document.querySelectorAll('.hbtn'));
      if (!chart || !Array.isArray({{ rows|tojson }})) return;

      const ROWS = {{ rows|tojson }};
      const data = ROWS.map(r => ({
        key:   (r.category_key || r.category || ''),
        label: (r.category_label || r.category || ''),
        wins:  Number(r.wins || 0),
        likert:Number(r.likert || 0)
      }));

      let mode = 'duel'; // 'duel' | 'likert'

      function render(){
        const vals = data.map(d => mode==='duel' ? d.wins : d.likert);
        const max  = Math.max(1, ...vals);
        chart.innerHTML = data.map(d=>{
          const v   = mode==='duel' ? d.wins : d.likert;
          const pct = Math.round(100 * (v / max));
          return `
            <div class="hrow" data-key="${d.key}">
              <div class="hbar"><span style="width:${pct}%"><em class="hlabel${pct<20?' outside':''}">${d.label}</em></span></div>
              <div style="text-align:right">${v}</div>
            </div>
          `;
        }).join('');
      }

      function setMode(m){
        mode = m;
        btns.forEach(b => b.classList.toggle('active', b.dataset.mode === mode));
        render();
      }

      btns.forEach(b => b.addEventListener('click', () => setMode(b.dataset.mode)));
      setMode('duel'); // výchozí zobrazení
    })();
    {% endif %}
  </script>
</body>
</html>
